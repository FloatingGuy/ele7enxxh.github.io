<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> mtkfb_ioctl函数越界写内存提权漏洞 · Ele7enxxh's Blog</title><meta name="description" content="mtkfb_ioctl函数越界写内存提权漏洞 - ele7enxxh"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/5545520757" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/ele7enxxh" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">mtkfb_ioctl函数越界写内存提权漏洞</h1><div class="post-info">Jul 30, 2015</div><div class="post-content"><p>本文主要研究了mtkfb_ioctl函数越界写内存提权漏洞的原理与利用。<a id="more"></a></p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>漏洞由nforest@KeenTeam发现，已于2015年年初报给厂商。详细分析请看KeenTeam高级研究员陈良在2015阿里移动技术峰会做出的报告“内存喷射在安卓Root利用中”。</p>
<h2 id="一些笔记"><a href="#一些笔记" class="headerlink" title="一些笔记"></a>一些笔记</h2><ol>
<li>选取display_id为0xA04EC4EC,因为0xA04EC4EC*0x34==0x208FFFFFF0==0x8FFFFFF0,可确保写0操作落在map的地址范围内？<br>dispif_info位于内核空间，故其地址一定大于0xC0000000。所以写0的地址也大于0xC0000000+0xA04EC4EC*0x34+0x20=0x50000010（对于32位系统，addr+0x100000000==addr），而我们map的起始地址0x50000000，所以可确保写0操作落在map的地址范围。</li>
<li>为什么要进行thread_info喷射？<br>虽然我们对display_id的取值进行了筛选，但是依然无法保证修改的一定是addr_limit。为了增大修改成功的概率，创建尽可能多的线程，以让thread_info结构体充斥在内核空间，大大提高了修改成功率。</li>
</ol>
<h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><p>根据nforest@KeenTeam的报告以及网上大牛的提权代码，整理了一份Exp，已经上传到github了：<br><a href="https://github.com/ele7enxxh/MtkfbExploit" target="_blank" rel="external">https://github.com/ele7enxxh/MtkfbExploit</a></p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ol>
<li><a href="http://wenku.baidu.com/link?url=E0TX6kLvnMZD7QoS5p3FdZivHcpkeYOBTTvSYFG8EqKsB-VI3yOIR6-NK8n-cMStwxgjIApQYr0M00_4Djkl7OlmEUIXagDxyA0-_dG1E-W" target="_blank" rel="external">http://wenku.baidu.com/link?url=E0TX6kLvnMZD7QoS5p3FdZivHcpkeYOBTTvSYFG8EqKsB-VI3yOIR6-NK8n-cMStwxgjIApQYr0M00_4Djkl7OlmEUIXagDxyA0-_dG1E-W</a></li>
<li><a href="https://github.com/android-rooting-tools/android_run_root_shell" target="_blank" rel="external">https://github.com/android-rooting-tools/android_run_root_shell</a></li>
</ol>
</div></article></div></section><footer><div class="paginator"><a href="/Analysis-Of-Backtrace-And-Inline-Hook-Thread-Safety-On-The-ARM-Platform.html" class="prev">PREV</a><a href="/Memory-Corruption-Qseecom-Driver-CVE-2014-4322-Analysis.html" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'ele7enxxh';
var disqus_identifier = 'Mtkfb-Exploit.html';
var disqus_title = 'mtkfb_ioctl函数越界写内存提权漏洞';
var disqus_url = 'http://ele7enxxh.com/Mtkfb-Exploit.html';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//ele7enxxh.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2016 <a href="http://ele7enxxh.com">ele7enxxh</a>, unless otherwise noted.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?e9925f9b47e12674b38b04ce3cde49e6";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></body></html>